/* Generated from ubus IDL - {{ obj_name }} */

#ifndef {{ header_guard }}
#define {{ header_guard }}

#include <libubus.h>
#include <stdint.h>

/* Helper macros for optional field operations */
#define UBUS_IDL_HAS_FIELD(params, mask) ((params)->has_fields & (mask))
#define UBUS_IDL_SET_FIELD(params, mask) ((params)->has_fields |= (mask))
#define UBUS_IDL_CLEAR_FIELD(params, mask) ((params)->has_fields &= ~(mask))

{# 全局类型 #}
{% for type_info in global_types %}
struct {{ type_info.struct_name }} {
{% for field in type_info.fields %}
    {{ field.c_type }} {{ field.name }};
{% endfor %}
{% if type_info.has_optional_fields %}
    unsigned int has_fields;
{% endif %}
};
{% for field in type_info.optional_fields %}
#define {{ field.macro_name }} (1U << {{ field.enum_item }})
{% endfor %}
{% if not loop.last %}

{% endif %}
{% endfor %}
{% if global_types and (object_types or method_params) %}

{% endif %}
{# 对象类型 #}
{% for type_info in object_types %}
struct {{ type_info.struct_name }} {
{% for field in type_info.fields %}
    {{ field.c_type }} {{ field.name }};
{% endfor %}
{% if type_info.has_optional_fields %}
    unsigned int has_fields;
{% endif %}
};
{% for field in type_info.optional_fields %}
#define {{ field.macro_name }} (1U << {{ field.enum_item }})
{% endfor %}
{% if not loop.last %}

{% endif %}
{% endfor %}
{% if object_types and method_params %}

{% endif %}
{# 方法参数结构体 #}
{% for method_info in method_params %}
struct {{ method_info.struct_name }} {
{% for param in method_info.params %}
    {{ param.c_type }} {{ param.name }};
{% endfor %}
{% if method_info.has_optional_params %}
    unsigned int has_fields;
{% endif %}
};
{% for param in method_info.optional_params %}
#define {{ method_info.prefix_upper }}_HAS_{{ param.name_upper }} (1U << {{ method_info.prefix_upper }}_{{ param.name_upper }})
{% endfor %}
{% if not loop.last %}

{% endif %}
{% endfor %}

{# 函数声明 - 所有处理器 #}
{% for method_info in all_methods %}
int {{ method_info.handler_name }}(struct ubus_context *ctx, struct ubus_object *obj, struct ubus_request_data *req, const char *method, struct blob_attr *msg);
{% endfor %}

{# 序列化/反序列化函数声明 #}
{% for type_info in serialize_types %}
int {{ type_info.deserialize_func }}(struct blob_attr *msg, struct {{ type_info.struct_type }} *params);
int {{ type_info.serialize_func }}(struct blob_buf *b, const struct {{ type_info.struct_type }} *params);
{% endfor %}

extern struct ubus_object {{ obj_name_lower }}_object;

#endif /* {{ header_guard }} */

