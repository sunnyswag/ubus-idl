/* Generated from ubus IDL - {{ obj_name }} */

#ifndef {{ header_guard }}
#define {{ header_guard }}

#include <libubus.h>
#include <stdint.h>

/* Helper macros for optional field operations */
#define UBUS_IDL_HAS_FIELD(params, mask) ((params)->has_fields & (mask))
#define UBUS_IDL_SET_FIELD(params, mask) ((params)->has_fields |= (mask))
#define UBUS_IDL_CLEAR_FIELD(params, mask) ((params)->has_fields &= ~(mask))

{# 定义可复用的结构体生成宏 #}
{% macro render_struct(struct_name, fields, optional_fields, has_optional, is_last, macro_prefix, enum_prefix) -%}
struct {{ struct_name }} {
{% for field in fields %}
    {{ field.c_type }} {{ field.name }};
{% endfor %}
{% if has_optional %}
    unsigned int has_fields;
{% endif %}
};
{% for field in optional_fields %}
{% if field.macro_name %}
#define {{ field.macro_name }} (1U << {{ field.enum_item }})
{% else %}
#define {{ macro_prefix }}_HAS_{{ field.name_upper }} (1U << {{ enum_prefix }}{{ field.name_upper }})
{% endif %}
{% endfor %}
{%- endmacro %}

{# 全局类型 #}
{% for type_info in global_types %}
{{ render_struct(type_info.struct_name, type_info.fields, type_info.optional_fields, type_info.has_optional_fields, loop.last, "", "") }}
{% endfor %}
{# 对象类型 #}
{% for type_info in object_types %}
{{ render_struct(type_info.struct_name, type_info.fields, type_info.optional_fields, type_info.has_optional_fields, loop.last, "", "") }}
{% endfor %}
{# 方法参数结构体 #}
{% for method_info in method_params %}
{{ render_struct(method_info.struct_name, method_info.params, method_info.optional_params, method_info.has_optional_params, loop.last, method_info.prefix_upper, method_info.prefix_upper + "_") }}
{% endfor %}

{# 函数声明 - 所有处理器 #}
{% for method_info in all_methods %}
int {{ method_info.handler_name }}(struct ubus_context *ctx, struct ubus_object *obj, struct ubus_request_data *req, const char *method, struct blob_attr *msg);
{% endfor %}

{# 序列化/反序列化函数声明 #}
{% for type_info in serialize_types %}
int {{ type_info.deserialize_func }}(struct blob_attr *msg, struct {{ type_info.struct_type }} *params);
int {{ type_info.serialize_func }}(struct blob_buf *b, const struct {{ type_info.struct_type }} *params);
{% endfor %}

extern struct ubus_object {{ obj_name_lower }}_object;

#endif /* {{ header_guard }} */

